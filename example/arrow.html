<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <style>
    /* #canvas {
      border: 1px solid #ccc;
    } */

    * {
      padding: 0;
      margin: 0;
    }
  </style>
</head>

<body>
  <canvas id="canvas"></canvas>
  <button onclick="setMode('curve')">curve</button>
  <button onclick="setMode('arrow')">arrow</button>

  <script>
    window.onload = () => {
      const canvas = document.getElementById("canvas");
      if (!canvas) {
        return;
      }

      let mode = "curve";

      function clear() {
        // clear canvas
        context.fillStyle = '#fff';
        context.clearRect(0, 0, canvas.width, canvas.height);
        // context.fillRect(0, 0, canvas.width, canvas.height);
      }

      function createPoint(x, y) {
        const rect = canvas.getBoundingClientRect();

        return { x: x - rect.left, y: y - rect.top, time: new Date().getTime() };
      }

      function drawCurve(context, beginPoint, endPoint) {
        context.save();

        context.beginPath();
        context.lineCap = "round";
        context.lineWidth = 2;
        context.lineJoin = "round";
        context.strokeStyle = "orange";
        context.moveTo(beginPoint.x, beginPoint.y);
        context.lineTo(endPoint.x, endPoint.y);
        context.stroke();
        context.closePath();
      }

      function drawArrow(context, beginPoint, endPoint) {
        const theta = 30;
        const hypotenuse = 10;
        const fromX = beginPoint.x;
        const fromY = beginPoint.y;
        const toX = endPoint.x;
        const toY = endPoint.y;

        const angle = (Math.atan2(fromY - toY, fromX - toX) * 180) / Math.PI;
        const angle1 = ((angle + theta) * Math.PI) / 180;
        const angle2 = ((angle - theta) * Math.PI) / 180;
        const topX = hypotenuse * Math.cos(angle1);
        const topY = hypotenuse * Math.sin(angle1);
        const botX = hypotenuse * Math.cos(angle2);
        const botY = hypotenuse * Math.sin(angle2);

        context.save();
        context.beginPath();

        let arrowX = fromX - topX;
        let arrowY = fromY - topY;

        context.moveTo(arrowX, arrowY);
        context.moveTo(fromX, fromY);
        context.lineTo(toX, toY);
        arrowX = toX + topX;
        arrowY = toY + topY;
        context.moveTo(arrowX, arrowY);
        context.lineTo(toX, toY);
        arrowX = toX + botX;
        arrowY = toY + botY;
        context.lineTo(arrowX, arrowY);
        context.strokeStyle = "orange";
        context.lineWidth = 2;
        context.stroke();
        context.closePath();
        context.restore();
      }

      function renderAll(context, arrowList) {
        console.log("renderAll", arrowList);
        for (const arrow of arrowList) {
          const { points } = arrow;
          if (points.length > 1) {
            drawArrow(context, points[0], points[arrow.length - 1]);
          }
        }
      }

      function setMode(mode) {
        console.log(mode);
        mode = mode;
      }

      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;

      const context = canvas.getContext("2d");

      const arrowList = [];

      let isMouseDown = false;

      function handleMouseDown(e) {
        // console.log("mousedown", e);
        if (e.which === 1) {
          isMouseDown = true;

          arrowList.push({
            points: [createPoint(e.clientX, e.clientY)],
          })

          handleMouseMove(e);
        }
      }

      function handleMouseMove(e) {
        // console.log("isMouseDown", isMouseDown);
        if (isMouseDown) {
          if (arrowList.length === 0) {
            handleMouseDown(e);
            return;
          }

          const point = createPoint(e.clientX, e.clientY);
          const lastArrow = arrowList[arrowList.length - 1];
          const lastPoint = lastArrow.points[lastArrow.points.length - 1];

          console.log(mode);

          if (mode === "curve") {
            drawCurve(context, lastPoint, point);
            lastArrow.points.push(point);
          }

          if (mode === "arrow") {
            window.requestAnimationFrame(() => {
              clear();

              lastArrow.points.push(point);
              drawArrow(context, firstPoint, point);

              // renderAll(context, arrowList);
            });
          }
        }
      }

      function handleMouseUp(e) {
        if (e.which === 1 && isMouseDown) {
          isMouseDown = false;
          handleMouseMove(e);
        }
      }

      canvas.addEventListener("mousedown", handleMouseDown);
      canvas.addEventListener("mousemove", handleMouseMove);
      canvas.addEventListener("mouseup", handleMouseUp);
    };
  </script>
</body>

</html>
